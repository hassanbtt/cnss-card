<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تطبيق تعديل البطاقة الصحية</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f9;
      display: flex;
      flex-direction: row;
      gap: 20px;
    }

    .right-section {
      flex: 1;
      max-width: 400px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .left-section {
      flex: 2;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    .form-row-single {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }

    .form-container label {
      font-weight: bold;
      white-space: nowrap;
    }

    .form-container input,
    .form-container select,
    .form-container button {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }

    .form-container button {
      background-color: #007bff;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none; /* تعطيل تحديد النص داخل الزر */
    }

    .form-container button:hover {
      background-color: #0056b3;
    }

    .button-row {
      display: flex;
      gap: 10px;
    }

    canvas {
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="right-section">
    <h1>تطبيق تعديل البطاقة الصحية</h1>
    <div class="form-container">
      <div class="form-row-single">
        <label for="registrationNumber">رقم التسجيل:</label>
        <input type="text" id="registrationNumber" placeholder="أدخل رقم التسجيل">
      </div>

      <div class="form-row-single">
        <label for="name">الاسم الشخصي:</label>
        <input type="text" id="name" placeholder="أدخل الاسم الشخصي">
      </div>

      <div class="form-row-single">
        <label for="surname">النسب:</label>
        <input type="text" id="surname" placeholder="أدخل النسب">
      </div>

      <div class="form-row-single">
        <label for="nom">Nom:</label>
        <input type="text" id="nom" placeholder="Enter your name">
      </div>

      <div class="form-row-single">
        <label for="prenom">Prénom:</label>
        <input type="text" id="prenom" placeholder="Enter family name">
      </div>

      <div class="form-row-single">
        <label for="birthDate">تاريخ الازدياد:</label>
        <input type="date" id="birthDate">
      </div>

      <div class="form-row-single">
        <label for="idNumber">C.I.N:</label>
        <input type="text" id="idNumber" placeholder="أدخل رقم البطاقة الوطنية">
      </div>

      <div class="form-row-single">
        <label for="registrationDate">تاريخ التسجيل:</label>
        <input type="date" id="registrationDate">
      </div>

      <div class="form-row-single">
        <label for="fontSize">حجم الخط:</label>
        <select id="fontSize">
          <option value="8">8</option>
          <option value="12">12</option>
		  <option value="13">13</option>
		  <option value="14">14</option>
		  <option value="15">15</option>
          <option value="16" selected>16</option>
		  <option value="17">17</option>
		  <option value="18">18</option>
          <option value="19">19</option>
          <option value="20">20</option>
          <option value="21">21</option>
        </select>
      </div>

      <div class="form-row-single">
        <label for="fontFamily">نوع الخط:</label>
        <select id="fontFamily">
          <option value="Arial" selected>Arial</option>
          <option value="Courier New">Courier New</option>
		  <option value="Georgia">Georgia</option>
          <option value="Times New Roman">Times New Roman</option>
		  <option value="Tahoma">Tahoma</option>
		  <option value="Comic Sans MS">Comic Sans MS</option>
		  <option value="Trebuchet MS">Trebuchet MS</option>
		  <option value="Lucida Console">Lucida Console</option>
		  <option value="Impact">Impact</option>
          <option value="Verdana">Verdana</option>
        </select>
      </div>

      <div class="button-row">
        <button id="updateCanvas">أضف المعلومات</button>
        <button id="download">حفظ الصورة</button>
      </div>
    </div>
  </div>

  <div class="left-section">
    <canvas id="canvas" width="322" height="205" style="width: 483px; height: 308px; border: 1px solid #ccc;"></canvas>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
	img.crossOrigin = 'Anonymous';
    img.src = 'cnss-card.jpg'; // ضع مسار الصورة
    let imgLoaded = false;
	let offsetX = 0;
	let offsetY = 0;

    // تعيين مواقع النصوص
    const textPositions = {
      registrationNumber: { x: 142, y: 69 },
      surname: { x: 192, y: 96 },
      nom: { x: 44, y: 96 },
      name: { x: 179, y: 121 },
      prenom: { x: 57, y: 121 },
      birthDate: { x: 150, y: 146 },
      idNumber: { x: 113, y: 168 },
      registrationDate: { x: 138, y: 193 },
    };

	// الحجم الحقيقي
    const realWidth = canvas.width;
	const realHeight = canvas.height;

	// الحجم الظاهر
	const displayedWidth = parseInt(getComputedStyle(canvas).width);
	const displayedHeight = parseInt(getComputedStyle(canvas).height);

	// النسبة بين الحجم الحقيقي والحجم الظاهر
	const scaleX = realWidth / displayedWidth;
	const scaleY = realHeight / displayedHeight;

	// لتحويل الإحداثيات الظاهرة إلى الحقيقية
	function toRealCoords(x, y) {
		return {
			x: x * scaleX,
			y: y * scaleY,
		};
	}

// لتحويل الإحداثيات الحقيقية إلى الظاهرة (اختياري)
	function toDisplayedCoords(x, y) {
	  return {
		x: x / scaleX,
		y: y / scaleY,
	  };
	}
	
    img.onload = () => {
      imgLoaded = true;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      drawText();
    };

    function drawText() {
      if (!imgLoaded) return;
	  ctx.clearRect(0, 0, canvas.width, canvas.height); // مسح الصورة القديمة
      // إعادة رسم الصورة
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      // إعدادات الخط
      const fontSize = document.getElementById('fontSize').value;
      const fontFamily = document.getElementById('fontFamily').value;
      ctx.font = `${fontSize}px ${fontFamily}`;
	  ctx.fillStyle = 'black';

	   // رسم النصوص
    for (const key in textPositions) {
        const textValue = document.getElementById(key).value;
        const textPos = textPositions[key];

        // اختيار اللون بناءً على النص
        if (key === 'registrationNumber') {
            ctx.fillStyle = 'white'; // اللون الأبيض لرقم التسجيل
        } else {
            ctx.fillStyle = 'black'; // اللون الأسود للنصوص الأخرى
        }

        // رسم النص
        ctx.fillText(textValue.toUpperCase(), textPos.x, textPos.y);
    }
    }
	
	function isMouseOverText(mouseX, mouseY, text, x, y) {
	  const metrics = ctx.measureText(text);
	  const textWidth = metrics.width;
	  const textHeight = parseInt(ctx.font); // ارتفاع الخط يكون نفس حجم الخط
	  return (
		mouseX >= x &&
		mouseX <= x + textWidth &&
		mouseY >= y - textHeight &&
		mouseY <= y
	  );
	}


    // إضافة النصوص عند الضغط على زر "أضف المعلومات"
    document.getElementById('updateCanvas').addEventListener('click', () => {
      drawText();
    });

    // حفظ الصورة عند الضغط على زر "حفظ الصورة"
    document.getElementById('download').addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // مسح الـ canvas
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height); // إعادة رسم الصورة الأصلية
      drawText(); // رسم النصوص مرة أخرى
	  
	  const link = document.createElement('a');
      link.download = 'health-card.png';
      link.href = canvas.toDataURL();
      link.click();
    });

    // تحريك النص باستخدام الماوس
    let isDragging = false;
    let draggedText = null;

    canvas.addEventListener('mousedown', (e) => {
      const mouseX = e.offsetX;
      const mouseY = e.offsetY;
	
	  // تحويل الإحداثيات الظاهرة إلى الحقيقية
	  const { x, y } = toRealCoords(mouseX, mouseY);
	
      // التحقق من النصوص بناءً على الإحداثيات الحقيقية
      for (const key in textPositions) {
        const text = document.getElementById(key).value;
        const textPos = textPositions[key];

        const fontSize = document.getElementById('fontSize').value;
        const fontFamily = document.getElementById('fontFamily').value;
        ctx.font = `${fontSize}px ${fontFamily}`;

        if (isMouseOverText(x, y, text, textPos.x, textPos.y)) {
            isDragging = true;
            draggedText = key;

            // حساب الفرق بين النص والماوس
            offsetX = x - textPos.x;
            offsetY = y - textPos.y;

            break;
        }
      }
    });

    canvas.addEventListener('mousemove', (e) => {
      if (isDragging && draggedText) {
        const mouseX = e.offsetX;
        const mouseY = e.offsetY;

        // تحويل الإحداثيات الظاهرة إلى الحقيقية
        const { x, y } = toRealCoords(mouseX, mouseY);

        // تحديث موقع النص مع احتساب الفرق
        textPositions[draggedText].x = x - offsetX;
        textPositions[draggedText].y = y - offsetY;

        ctx.clearRect(0, 0, canvas.width, canvas.height); // مسح الـ canvas
        drawText(); // إعادة رسم النصوص بعد التحريك
      }
    });

    canvas.addEventListener('mouseup', () => {
      isDragging = false;
      draggedText = null;
    });

    // تحريك النص باستخدام أزرار الكيبورد
    document.addEventListener('keydown', (e) => {
      if (!draggedText) return;

      const step = 5;
      if (e.key === 'ArrowUp') textPositions[draggedText].y -= step;
      if (e.key === 'ArrowDown') textPositions[draggedText].y += step;
      if (e.key === 'ArrowLeft') textPositions[draggedText].x -= step;
      if (e.key === 'ArrowRight') textPositions[draggedText].x += step;

      ctx.clearRect(0, 0, canvas.width, canvas.height); // مسح الـ canvas
      drawText(); // إعادة رسم النصوص بعد التحريك
    });
	
	canvas.addEventListener('mousedown', (e) => {
	  const mouseX = e.offsetX;
	  const mouseY = e.offsetY;

	  for (const key in textPositions) {
		const text = document.getElementById(key).value;
		const textPos = textPositions[key];

		const fontSize = document.getElementById('fontSize').value;
		const fontFamily = document.getElementById('fontFamily').value;
		ctx.font = `${fontSize}px ${fontFamily}`;

		if (isMouseOverText(mouseX, mouseY, text, textPos.x, textPos.y)) {
		  isDragging = true;
		  draggedText = key;
		  break;
		}
	  }
	});
  </script>
</body>
</html>
